name: Update README with WakaTime Stats

on:
  schedule:
    # Runs at 12am UTC every day
    - cron: "0 0 * * *"
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Fetch WakaTime Stats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          curl -s "https://wakatime.com/api/v1/users/current/stats/last_7_days?api_key=${WAKATIME_API_KEY}" -o wakatime_stats.json

      - name: Update README
        run: |
          total_time=$(jq -r '.data.human_readable_total' wakatime_stats.json)
          languages=$(jq -r '.data.languages[] | "- \(.name): \(.text)"' wakatime_stats.json)
          # Update the README.md
          sed -i '/<!--START_SECTION:waka-->/,/<!--END_SECTION:waka-->/c\
<!--START_SECTION:waka-->\n\
**WakaTime Stats:**\n\n\
**Total Time:** $total_time\n\n\
**Languages:**\n\
$languages\n\
<!--END_SECTION:waka-->' README.md

      - name: Commit Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git commit -m "Update README with WakaTime stats" || echo "No changes to commit"
          git push
